---
import SectionTitle from "@/components/SectionTitle.astro";

const handleSubmit = async (e) => {
  e.preventDefault();
  const form = e.target;
  const data = new FormData(form);

  try {
    const res = await fetch(form.action, {
      method: 'POST',
      body: data,
      headers: { Accept: 'application/json' }
    });

    if (res.ok) {
      const ip = await (await fetch('https://api.ipify.org?format=json')).json().then(r => r.ip);
      await fetch('/api/log-contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: data.get('name'),
          email: data.get('email'),
          message: data.get('message'),
          ip
        })
      });

      const msg = document.createElement('p');
      msg.textContent = '¡Enviado! Te respondemos en <24h';
      msg.className = 'mt-6 text-center text-green-400 font-bold text-lg';
      form.after(msg);
      form.reset();
    }
  } catch (err) {
    alert('Error de conexión');
  }
};
---

<section
  id="contact-section"
  class="relative flex flex-col items-center justify-center mt-48 mb-32 w-full"
>
  <SectionTitle>Contacto</SectionTitle>

  <p class="text-center text-lg opacity-80 mt-6 max-w-2xl">
    ¿Tienes alguna pregunta o idea? Escríbenos un mensaje y te responderemos
    lo antes posible.
  </p>

  <form
    action="https://formspree.io/f/mldowldp"
    method="POST"
    client:only="astro"
    on:submit|preventDefault={handleSubmit}
    class="mt-16 w-[90%] max-w-2xl flex flex-col gap-6
           p-10 rounded-2xl
           backdrop-blur-xl bg-white/30 dark:bg-black/30
           border border-white/40 dark:border-black/40
           shadow-[0_0_40px_rgba(255,255,255,0.15)]
           transition-all duration-500 hover:shadow-[0_0_60px_rgba(255,255,255,0.25)]"
  >
    <input type="hidden" name="_subject" value="Nuevo mensaje desde tu web" />

    <div class="flex flex-col">
      <label for="name" class="text-lg mb-2 font-medium">Nombre</label>
      <input
        id="name"
        name="name"
        type="text"
        required
        placeholder="Tu nombre"
        class="p-4 rounded-lg bg-white/60 dark:bg-black/40 border border-gray-300 dark:border-gray-700
               focus:outline-none focus:ring-2 focus:ring-primary/60 transition-all duration-300"
      />
    </div>

    <div class="flex flex-col">
      <label for="email" class="text-lg mb-2 font-medium">Correo electrónico</label>
      <input
        id="email"
        name="email"
        type="email"
        required
        placeholder="tucorreo@ejemplo.com"
        class="p-4 rounded-lg bg-white/60 dark:bg-black/40 border border-gray-300 dark:border-gray-700
               focus:outline-none focus:ring-2 focus:ring-primary/60 transition-all duration-300"
      />
    </div>

    <div class="flex flex-col">
      <label for="message" class="text-lg mb-2 font-medium">Mensaje</label>
      <textarea
        id="message"
        name="message"
        required
        rows="5"
        placeholder="Escribe tu mensaje..."
        class="p-4 rounded-lg bg-white/60 dark:bg-black/40 border border-gray-300 dark:border-gray-700
               focus:outline-none focus:ring-2 focus:ring-primary/60 transition-all duration-300 resize-none"
      ></textarea>
    </div>

    <button
      type="submit"
      class="mt-6 py-4 text-lg font-semibold text-white rounded-xl
             bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500
             shadow-[0_0_20px_rgba(147,51,234,0.5)]
             hover:shadow-[0_0_40px_rgba(147,51,234,0.7)]
             hover:scale-[1.02] active:scale-95
             transition-all duration-500"
    >
      Enviar mensaje
    </button>
  </form>
</section>

<style>
  #contact-section {
    animation: fadeIn 0.8s ease-in-out forwards;
    opacity: 0;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(30px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>